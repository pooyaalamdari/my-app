<!DOCTYPE html>
<html lang="fa" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>تولید عکس با متن و هایلایت</title>
    <style>
        @font-face {
            font-family: 'Far_Rooznameh';
            src: url('Far_Rooznameh.ttf') format('truetype');
            font-weight: normal;
            font-style: normal;
        }

        body {
            font-family: 'Far_Rooznameh', sans-serif;
            margin: 0;
            padding: 20px;
            background-color: #f0f2f5;
            display: flex;
            flex-direction: column;
            align-items: center;
            color: #333;
        }

        .main-content {
            display: flex;
            flex-wrap: wrap;
            gap: 20px;
            max-width: 1200px;
            width: 100%;
            justify-content: center;
            margin-bottom: 20px;
        }

        .controls {
            background-color: #fff;
            padding: 25px;
            border-radius: 10px;
            box-shadow: 0 4px 15px rgba(0, 0, 0, 0.1);
            flex: 1;
            min-width: 300px;
            display: flex;
            flex-direction: column;
            gap: 15px;
        }

        label {
            font-weight: bold;
            margin-bottom: 5px;
            display: block;
        }

        textarea {
            width: calc(100% - 20px);
            padding: 10px;
            border: 1px solid #ccc;
            border-radius: 5px;
            font-family: 'Far_Rooznameh', sans-serif;
            font-size: 16px;
            min-height: 150px;
            resize: vertical;
        }

        input[type="range"] {
            width: 100%;
            cursor: pointer;
        }

        button {
            padding: 12px 20px;
            background-color: #007bff;
            color: white;
            border: none;
            border-radius: 5px;
            cursor: pointer;
            font-size: 16px;
            transition: background-color 0.3s ease;
        }

        button:hover {
            background-color: #0056b3;
        }

        .output-section {
            width: 100%;
            display: flex;
            flex-direction: column;
            align-items: center;
            margin-top: 30px;
        }

        #imagePreviewContainer {
            /* Keep these CSS rules as they define the PREVIEW appearance */
            width: 1080px;
            height: 1080px;
            background-color: #1b1c1d;
            display: flex;
            justify-content: center; /* Center horizontally */
            align-items: center;     /* Center vertically */
            overflow: hidden;
            position: relative;
            box-shadow: 0 0 10px rgba(0, 0, 0, 0.2);
            text-align: center; /* Ensures text is centered within imagePreviewText if it doesn't wrap full width */
        }

        #imagePreviewText {
            color: white;
            font-family: 'Far_Rooznameh', sans-serif;
            font-size: 48px; /* Default font size */
            max-width: 90%; /* Allow text to wrap, but not take up full width to keep it centered */
            max-height: 90%; /* Similar for height */
            text-align: center; /* Center text lines within itself */
            padding: 50px;
            word-wrap: break-word;
            white-space: pre-wrap;
            line-height: 1.5;
            box-sizing: border-box; /* Include padding in width/height */
        }

        .highlighted {
            background-color: rgba(255, 255, 0, 0.7);
            color: black;
            padding: 2px 5px;
            border-radius: 3px;
        }

        #downloadBtn {
            margin-top: 20px;
            background-color: #28a745;
        }

        #downloadBtn:hover {
            background-color: #218838;
        }

        /* Responsive adjustments */
        @media (max-width: 1100px) {
            #imagePreviewContainer {
                /* These dimensions are for the DISPLAY of the preview on smaller screens.
                   The DOWNLOAD will still be 1080x1080 due to JS override. */
                width: 90vw;
                height: 90vw;
                max-width: 1080px; /* Cap at original size */
                max-height: 1080px;
            }
            #imagePreviewText {
                 padding: 5vw;
                 /* For small screens, you might need to adjust max-width/height if text wraps too much */
                 /* max-width: 80%; */
            }
        }
        @media (max-width: 768px) {
            .main-content {
                flex-direction: column;
            }
        }
    </style>
</head>
<body>
    <h1>ساخت تصویر با متن و هایلایت</h1>
    <div class="main-content">
        <div class="controls">
            <label for="textInput">متن خود را اینجا وارد کنید:</label>
            <textarea id="textInput" placeholder="متن مورد نظر خود را وارد کنید..."></textarea>

            <label for="fontSizeSlider">اندازه فونت: <span id="fontSizeValue">48</span>px</label>
            <input type="range" id="fontSizeSlider" min="10" max="100" value="48">

            <button id="highlightBtn">هایلایت کردن متن انتخاب شده</button>
        </div>
    </div>

    <div class="output-section">
        <h2>پیش‌نمایش تصویر</h2>
        <div id="imagePreviewContainer">
            <div id="imagePreviewText"></div>
        </div>
        <button id="downloadBtn">دانلود تصویر</button>
    </div>

    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
    <script>
        const textInput = document.getElementById('textInput');
        const imagePreviewText = document.getElementById('imagePreviewText');
        const fontSizeSlider = document.getElementById('fontSizeSlider');
        const fontSizeValue = document.getElementById('fontSizeValue');
        const highlightBtn = document.getElementById('highlightBtn');
        const downloadBtn = document.getElementById('downloadBtn');
        const imagePreviewContainer = document.getElementById('imagePreviewContainer');

        let highlightedRanges = []; // Stores {start, end} indices relative to textInput.value

        // Helper to escape HTML characters
        function escapeHtml(text) {
            var map = {
                '&': '&amp;',
                '<': '&lt;',
                '>': '&gt;',
                '"': '&quot;',
                "'": '&#039;'
            };
            return text.replace(/[&<>"']/g, function(m) { return map[m]; });
        }

        // Function to update the preview text and apply highlights
        function updatePreview() {
            let inputText = textInput.value;
            let highlightedHtml = '';
            let lastIndex = 0;

            // Sort ranges to process them correctly from start to end
            highlightedRanges.sort((a, b) => a.start - b.start);

            highlightedRanges.forEach(range => {
                // Ensure range is valid and within current text length
                if (range.start < inputText.length && range.end <= inputText.length && range.start < range.end) {
                    // Add text before the current highlight
                    highlightedHtml += escapeHtml(inputText.substring(lastIndex, range.start));
                    // Add the highlighted text
                    highlightedHtml += `<span class="highlighted">${escapeHtml(inputText.substring(range.start, range.end))}</span>`;
                    lastIndex = range.end;
                }
            });

            // Add any remaining text after the last highlight
            highlightedHtml += escapeHtml(inputText.substring(lastIndex));

            // Replace newlines with <br> for HTML rendering in the preview
            imagePreviewText.innerHTML = highlightedHtml.replace(/\n/g, '<br>');
        }

        // Event listener for text input
        textInput.addEventListener('input', () => {
            // If text is modified, clear existing highlights as indices might change
            highlightedRanges = [];
            updatePreview();
        });

        // Event listener for font size slider
        fontSizeSlider.addEventListener('input', () => {
            const fontSize = fontSizeSlider.value;
            fontSizeValue.textContent = fontSize;
            imagePreviewText.style.fontSize = `${fontSize}px`;
        });

        // Highlight button logic
        highlightBtn.addEventListener('click', () => {
            const start = textInput.selectionStart;
            const end = textInput.selectionEnd;

            if (start < end) { // Check if text is actually selected
                const newRange = { start, end };

                // Check for existing highlights that overlap or are duplicates
                let isOverlappingOrDuplicate = false;
                for (let i = 0; i < highlightedRanges.length; i++) {
                    const existingRange = highlightedRanges[i];
                    if ((newRange.start >= existingRange.start && newRange.start < existingRange.end) ||
                        (newRange.end > existingRange.start && newRange.end <= existingRange.end) ||
                        (existingRange.start >= newRange.start && existingRange.start < newRange.end) ||
                        (existingRange.end > newRange.start && existingRange.end <= newRange.end)) {
                        isOverlappingOrDuplicate = true;
                        break;
                    }
                }

                if (!isOverlappingOrDuplicate) {
                    highlightedRanges.push(newRange);
                    updatePreview(); // Re-render preview with new highlight
                } else {
                    alert('بخش انتخاب شده با هایلایت‌های قبلی همپوشانی دارد یا قبلاً هایلایت شده است.');
                }
            } else {
                alert('لطفاً بخشی از متن را برای هایلایت انتخاب کنید.');
            }
        });

        // Download button logic
        downloadBtn.addEventListener('click', () => {
            // Store original styles of imagePreviewText to restore them later
            const originalFontSize = imagePreviewText.style.fontSize;
            const originalPadding = imagePreviewText.style.padding;
            const originalTextAlign = imagePreviewText.style.textAlign;
            const originalLineHeight = imagePreviewText.style.lineHeight;
            const originalMaxWidth = imagePreviewText.style.maxWidth;
            const originalMaxHeight = imagePreviewText.style.maxHeight;

            // IMPORTANT: These are the styles html2canvas will use when capturing
            // They override the actual displayed styles for the purpose of capture.
            imagePreviewText.style.fontSize = fontSizeSlider.value + 'px';
            imagePreviewText.style.padding = '50px';
            imagePreviewText.style.textAlign = 'center';
            imagePreviewText.style.lineHeight = '1.5';
            imagePreviewText.style.maxWidth = '90%'; // Keep these for proper centering within the FINAL 1080px image
            imagePreviewText.style.maxHeight = '90%';

            // No need to temporarily change imagePreviewContainer dimensions in CSS.
            // html2canvas will directly generate the desired output size.
            html2canvas(imagePreviewContainer, {
                backgroundColor: null,
                // These parameters directly control the output canvas size
                width: 1080,
                height: 1080,
                scale: 2, // Capture at 2x resolution for better quality, then scale down to 1080x1080 if needed
                useCORS: true
            }).then(canvas => {
                const link = document.createElement('a');
                link.download = 'text_image.png';
                // Use canvas.toDataURL directly, as its dimensions are already controlled by html2canvas options
                link.href = canvas.toDataURL('image/png');
                link.click();

                // Restore original styles of imagePreviewText after capture
                imagePreviewText.style.fontSize = originalFontSize;
                imagePreviewText.style.padding = originalPadding;
                imagePreviewText.style.textAlign = originalTextAlign;
                imagePreviewText.style.lineHeight = originalLineHeight;
                imagePreviewText.style.maxWidth = originalMaxWidth;
                imagePreviewText.style.maxHeight = originalMaxHeight;

            }).catch(error => {
                console.error("Oops, something went wrong!", error);
                alert('خطایی در تولید تصویر رخ داد. لطفاً دوباره تلاش کنید.');
            });
        });

        // Initial setup
        updatePreview();
        imagePreviewText.style.fontSize = `${fontSizeSlider.value}px`;
    </script>
</body>
</html>